[tox]
envlist =
    tests

[testenv]

[testenv:tests]
# tox ignores the detection of a graphic card in the setup.py
# so set here to chose the cpu installation of torch
setenv =
    PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cpu
deps =
    pytest
commands =
    pytest {posargs}
    # doctest
    pytest --doctest-modules --pyargs torch_spex {posargs}

[testenv:benchmarks]
# this environement runs asv benchmarks on the current version of the repo
# asv is using the tox installation to run the benchmarks
# intented to be used by the users
setenv =
    PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cpu
deps =
    asv
    virtualenv
commands =
    # for debug you can add the options --verbose
    # PR COMMENT --attribute seems to ignored when config is present
    asv run --config asv.conf.json --show-stderr --python=same --dry-run {posargs}

[testenv:benchmarks-ci]
# This environement runs asv benchmarks quickly (one run) on the HEAD version.
# asv is using its installation as specified in the asv.conf.json to run the benchmarks
# intented to be used by the CI
skip_install = True
allowlist_externals =
    time
deps =
    asv
    virtualenv
commands =
    # asv requires the creation of a profile with the machine information.
    # Because it has problems automatically detecting the hardware on the CI machines,
    # we initialize the profile with default parameters
    asv machine --yes 
    # for debug you can add the options --verbose
    # --no-pull so it uses the checked out version of the repo ?PR COMMENT double check?
    # --strict return nonzero exit if benchmark fail
    # --dry-run dont record benchmarks
    # --quick run the benchmarks only once (no round, one sample, 1 number)
    time asv run --config asv.conf.json --show-stderr --dry-run --quick --parallel --no-pull --strict {posargs} 'HEAD^!'
